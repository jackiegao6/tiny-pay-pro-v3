<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‹¼å›¢é¡¹ç›® - å•†å“è¯¦æƒ…é¡µ</title>
    <link rel="stylesheet" href="css/index.css">

</head>
<body>
<!-- è½®æ’­å›¾ -->
<div class="swiper-container">
    <div class="swiper-wrapper">
        <div class="swiper-slide"><img src="./images/sku-13811216-01.png"></div>
        <!--        <div class="swiper-slide"><img src="./images/sku-13811216-02.png"></div>-->
        <!--        <div class="swiper-slide"><img src="./images/sku-13811216-03.png"></div>-->
    </div>
    <div class="swiper-pagination"></div>
</div>

<!-- å•†å“ä¿¡æ¯ -->
<div class="product-info">
    <h1 class="product-title">æ‰‹å†™MyBatisï¼šæ¸è¿›å¼æºç å®è·µï¼ˆå…¨å½©ï¼‰</h1>
    <span class="promotion-tag">å¤§ä¿ƒä¼˜æƒ </span>
    <span class="promotion-text"></span> <!-- åŠ¨æ€å¡«å……ä¿ƒé”€æ–‡æœ¬ -->
</div>

<!-- æ‹¼å•åˆ—è¡¨å®¹å™¨ -->
<div class="group-list">
    <!-- åŠ¨æ€ç”Ÿæˆæ‹¼å›¢åˆ—è¡¨ -->
</div>

<!-- ç©ºç™½åŒºåŸŸ -->
<div class="area"></div>

<!-- åº•éƒ¨æ“ä½œæ  -->
<div class="action-bar">
    <button class="action-btn buy-alone"></button>
    <button class="action-btn group-buy"></button>
</div>

<!-- æ”¯ä»˜å¼¹çª— -->
<div id="paymentModal" class="modal">
    <div class="modal-content">
        <h2>è¯·æ‰«ç æ”¯ä»˜</h2>
        <br/>
        <p id="paymentAmount" style="color:red;"></p>
        <!--        <img src="./images/sku-13811216-04.png" alt="æ”¯ä»˜äºŒç»´ç " class="qr-code">-->
        <p id="outTradeNo"></p>
        <div class="button-group">
            <button id="cancelPayment">å–æ¶ˆæ”¯ä»˜</button>
            <button id="completePayment">æ”¯ä»˜å®Œæˆ</button>
        </div>
    </div>
</div>
<script src="js/index.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // æ ¹æ®æµ‹è¯•è¯‰æ±‚ï¼Œè®¾ç½®åŸºç¡€åœ°å€
        var baseUrl = "http://127.0.0.1:8091";

        // è·å–ä¿¡æ¯
        var userId = getCookie("username");
        if (!userId) {
            window.location.href = "login.html"; // è·³è½¬åˆ°ç™»å½•é¡µ
            return;
        }

        // å®šä¹‰äº¤æ˜“å•å·ï¼Œå¦‚æœäº¤æ˜“å•å·ä¸ä¸ºç©ºï¼Œåˆ™å½“å‰ç”¨æˆ·å·²å‚ä¸æ‹¼å›¢äº¤æ˜“
        let outTradeNo = "";

        // è¯·æ±‚æ¥å£æ•°æ®
        fetch(baseUrl + '/api/v1/gbm/index/config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                userId: userId,
                goodsId: "9890001"
            })
        })
            .then(response => response.json())
            .then(res => {
                if (res.code !== 0) return;

                const {goodsInfo, teamInfos, teamStatisticInfo} = res.data;
                const groupList = document.querySelector('.group-list');
                const promotionText = document.querySelector('.promotion-text');

                // æ›´æ–°ä¿ƒé”€ä¿¡æ¯
                promotionText.textContent = `ç›´é™ Â¥${goodsInfo.deductionPrice.toFixed(0)}ï¼Œ${teamStatisticInfo.allTeamUserCount}äººåœ¨æŠ¢ï¼Œé€Ÿé€Ÿå‚ä¸`;

                // æ¸…ç©ºå¹¶ç”Ÿæˆæ‹¼å›¢åˆ—è¡¨
                groupList.innerHTML = '';

                if (teamInfos.length === 0) {
                    groupList.innerHTML = `
                <div class="group-item empty-tips">
                    <div class="tips-content">
                        å°ä¼™ä¼´ï¼Œèµ¶ç´§å»å¼€å›¢å§ï¼Œåšæ‘é‡Œæœ€é“çš„ä»”ï¼ğŸ‰
                    </div>
                </div>
            `;
                } else {
                    teamInfos.forEach(team => {
                        const remaining = team.targetCount - team.lockCount;
                        // åˆ¤æ–­å½“å‰ç”¨æˆ·IDæ˜¯å¦ä¸ºç™»å½•ç”¨æˆ·ID
                        if (userId == team.userId) {
                            outTradeNo = team.outTradeNo;
                        }

                        groupList.innerHTML += `
                    <div class="group-item">
                        <div>
                            <div class="user-info" data-teamId="${team.teamId}">${team.userId}</div>
                            <div class="group-status">
                                <span>ç»„é˜Ÿä»…å‰©${remaining}äººï¼Œæ‹¼å•å³å°†ç»“æŸ</span>
                                <span class="countdown">${team.validTimeCountdown}</span>
                            </div>
                        </div>
                        <div class="right">
                            <button class="group-btn" data-price="${goodsInfo.currentPrice.toFixed(0)}">å‚ä¸æ‹¼å›¢</button>
                        </div>
                    </div>
                `;
                    });
                }

                // æ›´æ–°åº•éƒ¨æŒ‰é’®
                const buyAloneBtn = document.querySelector('.buy-alone');
                const groupBuyBtn = document.querySelector('.group-buy');
                buyAloneBtn.textContent = `å•ç‹¬è´­ä¹°(ï¿¥${goodsInfo.originalPrice.toFixed(0)})`;
                buyAloneBtn.dataset.price = goodsInfo.originalPrice;
                groupBuyBtn.textContent = `å¼€å›¢è´­ä¹°(ï¿¥${goodsInfo.currentPrice.toFixed(0)})`;
                groupBuyBtn.dataset.price = goodsInfo.currentPrice;

                // ç»‘å®šæ”¯ä»˜äº‹ä»¶[æ‹¼å›¢è´­ä¹°]
                document.querySelectorAll('.group-btn, .group-buy').forEach(btn => {
                    btn.addEventListener('click', function () {

                        // å¦‚æœæœ‰å€¼ï¼Œåˆ™ç›´æ¥å±•ç¤ºæ”¯ä»˜æŒ‰é’®
                        if (outTradeNo) {
                            // æ˜¾ç¤ºæ”¯ä»˜å¼¹çª—
                            document.getElementById('paymentAmount').textContent =
                                `ï¿¥${this.dataset.price}`;
                            document.getElementById('outTradeNo').textContent =
                                outTradeNo;
                            document.getElementById('paymentModal').style.display = 'block';
                            return;
                        }

                        // è·å–æ‹¼å›¢ID
                        let teamId = null;
                        if (this.classList.contains('group-btn')) {
                            const groupItem = this.closest('.group-item');
                            const userInfo = groupItem.querySelector('.user-info');
                            teamId = userInfo.dataset.teamid;
                        }

                        outTradeNo = generateRandomNumber(12);

                        // æ„é€ è¯·æ±‚æ•°æ®ï¼ˆå‡è®¾activityIdå’ŒgoodsIdä»æŒ‰é’®datasetè·å–ï¼‰
                        const postData = {
                            userId: userId,
                            teamId: teamId,
                            activityId: 100123,
                            goodsId: "9890001",
                            outTradeNo: outTradeNo,
                            notifyUrl: baseUrl + "/api/v1/test/group_buy_notify"
                        };

                        // è°ƒç”¨æ”¯ä»˜æ¥å£
                        fetch(baseUrl + '/api/v1/gbm/trade/lock-order', {
                            method: 'POST',
                            headers: {
                                'content-type': 'application/json'
                            },
                            body: JSON.stringify(postData)
                        })
                            .then(response => response.json())
                            .then(res => {
                                if (res.code !== 0) {
                                    // å¤±è´¥ï¼Œæ¸…ç©ºäº¤æ˜“ID
                                    outTradeNo = null;
                                    alert(res.code + "ï¼š" + res.info);
                                    return;
                                }

                                // æ˜¾ç¤ºæ”¯ä»˜å¼¹çª—
                                document.getElementById('paymentAmount').textContent =
                                    `ï¿¥${this.dataset.price}`;
                                document.getElementById('outTradeNo').textContent =
                                    outTradeNo;
                                document.getElementById('paymentModal').style.display = 'block';
                            })
                            .catch(error => {
                                console.error('æ”¯ä»˜è¯·æ±‚å¤±è´¥:', error);
                            });
                    });
                });

                // å¯åŠ¨å€’è®¡æ—¶
                document.querySelectorAll('.countdown').forEach(el => {
                    new Countdown(el, el.textContent);
                });

            });

        // æ”¯ä»˜æ¨¡å—
        const modal = document.getElementById("paymentModal")
        const paymentAmount = document.getElementById("paymentAmount")
        const cancelPayment = document.getElementById("cancelPayment")
        const completePayment = document.getElementById("completePayment")

        // è·å–æ‰€æœ‰çš„æŒ‰é’®
        const buttons = document.querySelectorAll(".buy-alone")
        // ä¸ºæ¯ä¸ªæŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
        buttons.forEach((button) => {
            button.addEventListener("click", function () {
                var userId = getCookie("username");
                if (!userId) {
                    window.location.href = "login.html"; // è·³è½¬åˆ°ç™»å½•é¡µ
                    return;
                }

                const price = this.getAttribute("data-price")
                showPaymentModal(price)
            })
        })

        // æ˜¾ç¤ºæ”¯ä»˜å¼¹çª—
        function showPaymentModal(price) {
            paymentAmount.textContent = `æ”¯ä»˜é‡‘é¢ï¼šï¿¥${price}`
            modal.style.display = "block"
        }

        // éšè—æ”¯ä»˜å¼¹çª—
        function hidePaymentModal() {
            modal.style.display = "none"
        }

        // å–æ¶ˆæ”¯ä»˜
        cancelPayment.addEventListener("click", hidePaymentModal)

        // æ”¯ä»˜å®Œæˆ
        completePayment.addEventListener("click", () => {
            // ç”Ÿæˆç¬¦åˆè¦æ±‚çš„äº¤æ˜“æ—¶é—´æ ¼å¼
            const formatTime = date => date.toISOString()
                .replace(/T/, ' ')
                .replace(/\..+/, '')
                .substr(0, 19);

            // æ„é€ è¯·æ±‚å‚æ•°
            const postData = {
                userId: userId,
                outTradeNo: outTradeNo,
                outTradeTime: new Date()
            };

            // è°ƒç”¨ç»“ç®—æ¥å£
            fetch(baseUrl + '/api/v1/gbm/trade/settlement_market_pay_order', {
                method: 'POST',
                headers: {
                    'content-type': 'application/json'
                },
                body: JSON.stringify(postData)
            })
                .then(response => response.json())
                .then(res => {
                    outTradeNo = null;
                    if (res.code === 0) {
                        alert('æ”¯ä»˜&ç»“ç®—æˆåŠŸï¼');
                        window.location.reload(); // æ”¯ä»˜æˆåŠŸååˆ·æ–°é¡µé¢
                    } else {
                        alert(`æ”¯ä»˜&ç»“ç®—å¤±è´¥ï¼š${res.info || 'æœªçŸ¥é”™è¯¯'}`);
                    }
                })
                .catch(error => {
                    console.error('æ¥å£è¯·æ±‚å¤±è´¥:', error);
                    alert('ç½‘ç»œå¼‚å¸¸ï¼Œè¯·æ£€æŸ¥è¿æ¥');
                })
                .finally(() => {
                    hidePaymentModal(); // å§‹ç»ˆå…³é—­å¼¹çª—
                });

        })

        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­å¼¹çª—
        window.addEventListener("click", (event) => {
            if (event.target == modal) {
                hidePaymentModal()
            }
        })

    });
</script>

</body>
</html>
